{% extends "base.html" %}

{% block title %}Technical Analysis - {{ symbol }}{% endblock %}

{% block content %}

<!-- Analysis Loading State -->
<div id="loading-state" class="py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <div class="loading mx-auto mb-4" style="width: 40px; height: 40px;"></div>
        <h2 class="text-2xl font-semibold text-gray-900 mb-2">Analyzing {{ symbol }}</h2>
        <p class="text-gray-600">
            Generating comprehensive technical analysis with Fibonacci, volume, and pattern detection...
        </p>
        <div class="mt-6 flex justify-center space-x-8 text-sm text-gray-500">
            <span class="pulse-animation"><i class="fas fa-chart-line mr-1"></i>Fibonacci Analysis</span>
            <span class="pulse-animation" style="animation-delay: 0.5s;"><i class="fas fa-volume-up mr-1"></i>Volume Patterns</span>
            <span class="pulse-animation" style="animation-delay: 1s;"><i class="fas fa-shapes mr-1"></i>Chart Patterns</span>
        </div>
    </div>
</div>

<!-- Analysis Results -->
<div id="analysis-results" class="hidden">
    
    <!-- Stock Header -->
    <section class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button onclick="goBack()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-arrow-left text-xl"></i>
                    </button>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">{{ symbol }}</h1>
                        <div id="stock-subtitle" class="text-gray-600"></div>
                    </div>
                </div>
                
                <div class="text-right">
                    <div id="current-price" class="text-2xl font-bold"></div>
                    <div id="price-change" class="text-sm"></div>
                    <div id="analysis-date" class="text-xs text-gray-500 mt-1"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Key Insights Banner -->
    <section id="insights-banner" class="py-4 hidden">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="trend-indicator" class="rounded-lg p-4 text-center text-white font-semibold"></div>
        </div>
    </section>

    <!-- Analysis Tabs -->
    <section class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <nav class="flex space-x-8">
                <button onclick="showTab('overview')" class="tab-button active py-4 px-2 border-b-2 border-blue-600 text-blue-600 font-semibold">
                    <i class="fas fa-chart-line mr-1"></i>Overview
                </button>
                <button onclick="showTab('fibonacci')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-expand-arrows-alt mr-1"></i>Fibonacci
                </button>
                <button onclick="showTab('patterns')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-shapes mr-1"></i>Patterns
                </button>
                <button onclick="showTab('volume')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-volume-up mr-1"></i>Volume
                </button>
                <button onclick="showTab('recommendations')" class="tab-button py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    <i class="fas fa-target mr-1"></i>Recommendations
                </button>
            </nav>
        </div>
    </section>

    <!-- Tab Content -->
    <div class="py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            
            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content">
                <div class="grid lg:grid-cols-3 gap-8 mb-8">
                    <!-- Current Trend -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="font-semibold text-lg mb-4 text-blue-600">
                            <i class="fas fa-trending-up mr-2"></i>Current Trend
                        </h3>
                        <div id="trend-analysis" class="space-y-3"></div>
                    </div>
                    
                    <!-- Key Levels -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="font-semibold text-lg mb-4 text-green-600">
                            <i class="fas fa-crosshairs mr-2"></i>Key Levels
                        </h3>
                        <div id="key-levels" class="space-y-3"></div>
                    </div>
                    
                    <!-- Volume Status -->
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="font-semibold text-lg mb-4 text-orange-600">
                            <i class="fas fa-volume-up mr-2"></i>Volume Status
                        </h3>
                        <div id="volume-status" class="space-y-3"></div>
                    </div>
                </div>
                
                <!-- Trading Opportunities -->
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="font-semibold text-lg mb-4 text-purple-600">
                        <i class="fas fa-bullseye mr-2"></i>Active Trading Opportunities
                    </h3>
                    <div id="trading-opportunities"></div>
                </div>
            </div>

            <!-- Fibonacci Tab -->
            <div id="fibonacci-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="font-semibold text-lg mb-4">
                        <i class="fas fa-expand-arrows-alt mr-2 text-blue-600"></i>Fibonacci Analysis
                    </h3>
                    <div id="fibonacci-content"></div>
                </div>
            </div>

            <!-- Patterns Tab -->
            <div id="patterns-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="font-semibold text-lg mb-4">
                        <i class="fas fa-shapes mr-2 text-green-600"></i>Chart Patterns
                    </h3>
                    <div id="patterns-content"></div>
                </div>
            </div>

            <!-- Volume Tab -->
            <div id="volume-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="font-semibold text-lg mb-4">
                        <i class="fas fa-volume-up mr-2 text-orange-600"></i>Volume Analysis
                    </h3>
                    <div id="volume-content"></div>
                </div>
            </div>

            <!-- Recommendations Tab -->
            <div id="recommendations-tab" class="tab-content hidden">
                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="font-semibold text-lg mb-4">
                        <i class="fas fa-target mr-2 text-purple-600"></i>Trading Recommendations
                    </h3>
                    <div id="recommendations-content"></div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- Error State -->
<div id="error-state" class="py-16 hidden">
    <div class="max-w-2xl mx-auto text-center px-4">
        <i class="fas fa-exclamation-triangle text-6xl text-red-500 mb-4"></i>
        <h2 class="text-2xl font-semibold text-gray-900 mb-2">Analysis Failed</h2>
        <p class="text-gray-600 mb-6" id="error-message"></p>
        <div class="space-x-4">
            <button onclick="retryAnalysis()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                <i class="fas fa-redo mr-2"></i>Retry Analysis
            </button>
            <button onclick="goBack()" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentSymbol = '{{ symbol }}';
let analysisData = null;

// Initialize analysis on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAnalysis();
});

function loadAnalysis() {
    showState('loading');
    
    fetch(`/api/analyze/${currentSymbol}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            analysisData = data;
            displayAnalysis(data);
            showState('results');
            showToast('Analysis completed successfully!', 'success');
        })
        .catch(error => {
            console.error('Analysis error:', error);
            showError(error.message);
        });
}

function displayAnalysis(data) {
    // Update stock header
    updateStockHeader(data);
    
    // Update overview tab
    updateOverviewTab(data);
    
    // Update fibonacci tab
    updateFibonacciTab(data);
    
    // Update patterns tab
    updatePatternsTab(data);
    
    // Update volume tab
    updateVolumeTab(data);
    
    // Update recommendations tab
    updateRecommendationsTab(data);
    
    // Show insights banner
    updateInsightsBanner(data);
}

function updateStockHeader(data) {
    if (data.analysis_summary) {
        document.getElementById('stock-subtitle').textContent = 
            `${data.analysis_summary.analysis_focus} • ${data.analysis_summary.analysis_date}`;
        document.getElementById('current-price').textContent = 
            formatINR(data.analysis_summary.current_price);
        document.getElementById('analysis-date').textContent = 
            `Last updated: ${data.analysis_summary.analysis_date}`;
    }
    
    // Add price change if available
    if (data.current_market_structure && data.current_market_structure.momentum) {
        const dayChange = data.current_market_structure.momentum['1_day'];
        if (dayChange) {
            const changeClass = dayChange.direction === 'Positive' ? 'text-green-600' : 'text-red-600';
            const changeIcon = dayChange.direction === 'Positive' ? 'fa-arrow-up' : 'fa-arrow-down';
            document.getElementById('price-change').innerHTML = 
                `<i class="fas ${changeIcon} mr-1"></i><span class="${changeClass}">₹${dayChange.change} (${dayChange.change_pct}%)</span>`;
        }
    }
}

function updateInsightsBanner(data) {
    const banner = document.getElementById('insights-banner');
    const indicator = document.getElementById('trend-indicator');
    
    if (data.current_market_structure && data.current_market_structure.current_trend) {
        const trend = data.current_market_structure.current_trend;
        const bias = trend.bias || 'Neutral';
        const strength = trend.strength || 'Moderate';
        
        let bgColor = 'bg-gray-500';
        if (bias === 'Bullish') bgColor = 'bg-green-500';
        if (bias === 'Bearish') bgColor = 'bg-red-500';
        
        indicator.className = `${bgColor} rounded-lg p-4 text-center text-white font-semibold`;
        indicator.innerHTML = `
            <div class="flex items-center justify-center space-x-4">
                <span>${bias} Trend (${strength})</span>
                <span>•</span>
                <span>Current: ${formatINR(trend.current_price)}</span>
            </div>
        `;
        
        banner.classList.remove('hidden');
    }
}

function updateOverviewTab(data) {
    // Trend Analysis
    if (data.current_market_structure) {
        const trendHtml = generateTrendHTML(data.current_market_structure);
        document.getElementById('trend-analysis').innerHTML = trendHtml;
    }
    
    // Key Levels
    if (data.fibonacci_analysis && data.fibonacci_analysis.closest_levels) {
        const levelsHtml = generateKeyLevelsHTML(data.fibonacci_analysis.closest_levels);
        document.getElementById('key-levels').innerHTML = levelsHtml;
    }
    
    // Volume Status
    if (data.volume_analysis) {
        const volumeHtml = generateVolumeStatusHTML(data.volume_analysis);
        document.getElementById('volume-status').innerHTML = volumeHtml;
    }
    
    // Trading Opportunities
    if (data.active_patterns) {
        const opportunitiesHtml = generateTradingOpportunitiesHTML(data.active_patterns);
        document.getElementById('trading-opportunities').innerHTML = opportunitiesHtml;
    }
}

function updateFibonacciTab(data) {
    if (data.fibonacci_analysis) {
        const fibHtml = generateFibonacciHTML(data.fibonacci_analysis);
        document.getElementById('fibonacci-content').innerHTML = fibHtml;
    }
}

function updatePatternsTab(data) {
    if (data.active_patterns) {
        const patternsHtml = generatePatternsHTML(data.active_patterns);
        document.getElementById('patterns-content').innerHTML = patternsHtml;
    }
}

function updateVolumeTab(data) {
    if (data.volume_analysis) {
        const volumeHtml = generateFullVolumeHTML(data.volume_analysis);
        document.getElementById('volume-content').innerHTML = volumeHtml;
    }
}

function updateRecommendationsTab(data) {
    if (data.immediate_trading_plan) {
        const recHtml = generateRecommendationsHTML(data.immediate_trading_plan);
        document.getElementById('recommendations-content').innerHTML = recHtml;
    }
}

// HTML Generation Functions
function generateTrendHTML(market) {
    if (!market.current_trend) return '<div class="text-gray-500">No trend data available</div>';
    
    const trend = market.current_trend;
    const momentum = market.momentum || {};
    
    return `
        <div class="space-y-2">
            <div class="flex justify-between">
                <span class="text-gray-600">Direction:</span>
                <span class="font-semibold ${trend.bias === 'Bullish' ? 'text-green-600' : trend.bias === 'Bearish' ? 'text-red-600' : 'text-gray-600'}">${trend.direction}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Strength:</span>
                <span class="font-semibold">${trend.strength}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">SMA 10:</span>
                <span class="font-medium">${formatINR(trend.sma_10)}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">SMA 20:</span>
                <span class="font-medium">${formatINR(trend.sma_20)}</span>
            </div>
        </div>
    `;
}

function generateKeyLevelsHTML(levels) {
    if (!levels || !levels.length) return '<div class="text-gray-500">No key levels identified</div>';
    
    return levels.slice(0, 4).map(level => `
        <div class="flex justify-between">
            <span class="text-gray-600">${level.level}:</span>
            <div class="text-right">
                <div class="font-semibold">${formatINR(level.price)}</div>
                <div class="text-xs text-gray-500">${level.distance_percent}% away</div>
            </div>
        </div>
    `).join('');
}

function generateVolumeStatusHTML(volume) {
    if (!volume.volume_profile) return '<div class="text-gray-500">No volume data available</div>';
    
    const profile = volume.volume_profile;
    return `
        <div class="space-y-2">
            <div class="flex justify-between">
                <span class="text-gray-600">Current Volume:</span>
                <span class="font-semibold">${profile.current_volume.toLocaleString()}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Assessment:</span>
                <span class="font-semibold ${profile.volume_assessment === 'High' ? 'text-orange-600' : 'text-gray-600'}">${profile.volume_assessment}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">vs Average:</span>
                <span class="font-medium">${profile.volume_ratio_to_average}x</span>
            </div>
            <div class="text-xs text-gray-500 mt-2">${profile.volume_significance}</div>
        </div>
    `;
}

function generateTradingOpportunitiesHTML(patterns) {
    if (!patterns || !patterns.length) return '<div class="text-gray-500">No active patterns identified</div>';
    
    return patterns.map(pattern => `
        <div class="border rounded-lg p-4 mb-4">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h4 class="font-semibold text-lg">${pattern.pattern_name}</h4>
                    <p class="text-sm text-gray-600">${pattern.expected_direction} • Reliability: ${pattern.reliability_score}</p>
                </div>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${pattern.status}</span>
            </div>
            
            ${pattern.trading_setup ? `
                <div class="grid md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <div class="font-medium text-green-600">Entry Trigger</div>
                        <div>${formatINR(pattern.trading_setup.entry_strategy?.trigger_price || pattern.trading_setup.entry_trigger)}</div>
                    </div>
                    <div>
                        <div class="font-medium text-blue-600">Target</div>
                        <div>${formatINR(pattern.trading_setup.entry_strategy?.target_price || pattern.trading_setup.target_price)}</div>
                    </div>
                </div>
            ` : ''}
            
            <div class="mt-3 text-sm text-gray-600">
                <strong>Next Action:</strong> ${pattern.next_action || pattern.timeline || 'Monitor for development'}
            </div>
        </div>
    `).join('');
}

function generateFibonacciHTML(fib) {
    let html = `
        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
            <h4 class="font-semibold mb-2">Analysis Method</h4>
            <p class="text-sm text-gray-600 mb-2">${fib.current_fibonacci_analysis?.trend_direction === 'up' ? 'Uptrend' : 'Downtrend'} Analysis</p>
            <div class="text-sm space-y-1">
                <div>Swing High: ₹${fib.fibonacci_retracements?.swing_high?.price} (${fib.fibonacci_retracements?.swing_high?.date})</div>
                <div>Swing Low: ₹${fib.fibonacci_retracements?.swing_low?.price} (${fib.fibonacci_retracements?.swing_low?.date})</div>
            </div>
        </div>
    `;
    
    if (fib.fibonacci_retracements?.retracement_levels) {
        html += `
            <div class="mb-6">
                <h4 class="font-semibold mb-3">Retracement Levels</h4>
                <div class="space-y-2">
                    ${fib.fibonacci_retracements.retracement_levels.map(level => `
                        <div class="flex items-center justify-between p-2 rounded ${level.level.includes('61.8') ? 'bg-yellow-50' : 'bg-gray-50'}">
                            <span class="font-medium">${level.level}</span>
                            <div class="text-right">
                                <div class="font-semibold">${formatINR(level.price)}</div>
                                <div class="text-xs text-gray-500">${level.significance}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    if (fib.fibonacci_extensions?.extension_levels) {
        html += `
            <div>
                <h4 class="font-semibold mb-3">Extension Targets</h4>
                <div class="space-y-2">
                    ${fib.fibonacci_extensions.extension_levels.map(level => `
                        <div class="flex items-center justify-between p-2 rounded ${level.level.includes('161.8') ? 'bg-green-50' : 'bg-gray-50'}">
                            <span class="font-medium">${level.level}</span>
                            <div class="text-right">
                                <div class="font-semibold">${formatINR(level.price)}</div>
                                <div class="text-xs text-gray-500">${level.significance}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    return html;
}

function generatePatternsHTML(patterns) {
    if (!patterns || !patterns.length) {
        return '<div class="text-gray-500 text-center py-8">No active chart patterns detected</div>';
    }
    
    return patterns.map(pattern => `
        <div class="border rounded-lg p-6 mb-6">
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h4 class="font-semibold text-xl">${pattern.pattern_name}</h4>
                    <p class="text-gray-600">${pattern.pattern_type} • ${pattern.expected_direction}</p>
                </div>
                <div class="text-right">
                    <div class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">${pattern.status}</div>
                    <div class="text-sm text-gray-500 mt-1">Reliability: ${pattern.reliability_score}</div>
                </div>
            </div>
            
            ${pattern.trading_setup ? `
                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div class="p-3 bg-green-50 rounded">
                        <div class="font-medium text-green-700">Entry Trigger</div>
                        <div class="text-lg font-semibold">${formatINR(pattern.trading_setup.entry_strategy?.trigger_price || pattern.trading_setup.entry_trigger)}</div>
                    </div>
                    <div class="p-3 bg-blue-50 rounded">
                        <div class="font-medium text-blue-700">Target</div>
                        <div class="text-lg font-semibold">${formatINR(pattern.trading_setup.entry_strategy?.target_price || pattern.trading_setup.target_price)}</div>
                    </div>
                    <div class="p-3 bg-red-50 rounded">
                        <div class="font-medium text-red-700">Stop Loss</div>
                        <div class="text-lg font-semibold">${formatINR(pattern.trading_setup.entry_strategy?.stop_loss || pattern.trading_setup.stop_loss)}</div>
                    </div>
                </div>
            ` : ''}
            
            ${pattern.volume_confirmation ? `
                <div class="p-3 bg-gray-50 rounded mb-3">
                    <div class="font-medium text-gray-700 mb-1">Volume Confirmation</div>
                    <div class="text-sm">${pattern.volume_confirmation.pattern_volume_support || 'Volume analysis available'}</div>
                </div>
            ` : ''}
            
            <div class="text-sm text-gray-600">
                <strong>Timeline:</strong> ${pattern.timeline || pattern.next_action || 'Monitor for development'}
            </div>
        </div>
    `).join('');
}

function generateFullVolumeHTML(volume) {
    let html = '';
    
    if (volume.volume_profile) {
        html += `
            <div class="mb-6 p-4 bg-orange-50 rounded-lg">
                <h4 class="font-semibold mb-3">Volume Profile</h4>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <div class="flex justify-between py-1">
                            <span>Current Volume:</span>
                            <span class="font-semibold">${volume.volume_profile.current_volume.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between py-1">
                            <span>30-Day Average:</span>
                            <span>${volume.volume_profile.average_volume_30d.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between py-1">
                            <span>Volume Ratio:</span>
                            <span class="font-semibold">${volume.volume_profile.volume_ratio_to_average}x</span>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between py-1">
                            <span>Assessment:</span>
                            <span class="font-semibold ${volume.volume_profile.volume_assessment === 'High' ? 'text-orange-600' : 'text-gray-600'}">${volume.volume_profile.volume_assessment}</span>
                        </div>
                        <div class="flex justify-between py-1">
                            <span>Trend:</span>
                            <span class="font-semibold">${volume.volume_profile.volume_trend}</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3 p-2 bg-white rounded text-sm">
                    ${volume.volume_profile.volume_significance}
                </div>
            </div>
        `;
    }
    
    if (volume.recent_volume_anomalies?.volume_anomalies) {
        html += `
            <div class="mb-6">
                <h4 class="font-semibold mb-3">Volume Anomalies</h4>
                <div class="space-y-3">
                    ${volume.recent_volume_anomalies.volume_anomalies.map(anomaly => `
                        <div class="p-3 border rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-medium">${anomaly.date}</span>
                                <span class="px-2 py-1 text-xs rounded ${anomaly.anomaly_type.includes('High') ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">${anomaly.anomaly_type}</span>
                            </div>
                            <div class="text-sm text-gray-600">
                                Volume: ${anomaly.volume.toLocaleString()} (${anomaly.volume_ratio}x average)
                            </div>
                            <div class="text-sm text-gray-500 mt-1">${anomaly.significance}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    return html || '<div class="text-gray-500 text-center py-8">Volume analysis not available</div>';
}

function generateRecommendationsHTML(plan) {
    let html = `
        <div class="mb-6 p-4 ${plan.trading_bias === 'Bullish' ? 'bg-green-50' : plan.trading_bias === 'Bearish' ? 'bg-red-50' : 'bg-gray-50'} rounded-lg">
            <h4 class="font-semibold mb-2">Trading Bias: <span class="${plan.trading_bias === 'Bullish' ? 'text-green-600' : plan.trading_bias === 'Bearish' ? 'text-red-600' : 'text-gray-600'}">${plan.trading_bias}</span></h4>
            <p class="text-sm">${plan.position_recommendations?.current_stance || 'Monitor market conditions'}</p>
        </div>
    `;
    
    if (plan.immediate_actions) {
        html += `
            <div class="mb-6">
                <h4 class="font-semibold mb-3">Immediate Actions</h4>
                <div class="space-y-3">
                    ${plan.immediate_actions.map(action => `
                        <div class="p-4 border rounded-lg">
                            <div class="flex items-start justify-between mb-2">
                                <h5 class="font-semibold">${action.specific_action}</h5>
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">${action.priority} Priority</span>
                            </div>
                            ${action.trigger_price ? `
                                <div class="text-sm text-gray-600 mb-1">
                                    <strong>Trigger:</strong> ${formatINR(action.trigger_price)}
                                </div>
                            ` : ''}
                            <div class="text-sm text-gray-600">
                                <strong>Timeline:</strong> ${action.timeline}
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    if (plan.fibonacci_key_levels) {
        html += `
            <div>
                <h4 class="font-semibold mb-3">Key Fibonacci Levels to Watch</h4>
                <div class="space-y-2">
                    ${plan.fibonacci_key_levels.map(level => `
                        <div class="flex items-center justify-between p-2 border rounded">
                            <span class="font-medium">${level.level_name}</span>
                            <div class="text-right">
                                <div class="font-semibold">${formatINR(level.price)}</div>
                                <div class="text-xs text-gray-500">${level.distance_percent}% away</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    return html;
}

// Tab functionality
function showTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-blue-600', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.remove('hidden');
    
    // Add active class to selected button
    event.target.classList.add('active', 'border-blue-600', 'text-blue-600');
    event.target.classList.remove('border-transparent', 'text-gray-500');
}

// Navigation functions
function goBack() {
    window.location.href = '/dashboard';
}

function retryAnalysis() {
    loadAnalysis();
}

// State management
function showState(state) {
    document.getElementById('loading-state').classList.toggle('hidden', state !== 'loading');
    document.getElementById('analysis-results').classList.toggle('hidden', state !== 'results');
    document.getElementById('error-state').classList.toggle('hidden', state !== 'error');
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    showState('error');
    showToast('Analysis failed. Please try again.', 'error');
}
</script>
{% endblock %}